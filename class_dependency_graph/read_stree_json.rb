#!/usr/bin/env ruby

require "json"
require 'syntax_tree'
require "amazing_print"

# Path to the JSON file generated by stree
json_file_path = "user.rb.json"

# Load and parse the JSON data
json_data = JSON.parse(File.read(json_file_path))

ap json_data  #, index: false

puts json_data.size

# Recursive function to search for pattern SomeClassName.new in nodes
def search_nodes(nodes)
  matching_nodes = []
  nodes.each do |node|
    # Check if the node matches the pattern (e.g., a method call with `.new`)
    if  node["type"]                == "call" && 
        node.dig("target", "type")  == "const_ref" && 
        node["message"]             == "new"
      
      # Optionally, you can adjust the condition to fit specifically "SomeClassName" or any class name

      matching_nodes << node
    end

    # Recursively search in children nodes, if any
    node.each do |key, value|
      matching_nodes.concat(search_nodes(value)) if value.is_a?(Array)
    end
  end

  matching_nodes
end

# Start searching from the root
matching_nodes = search_nodes([json_data])

# Output or process found nodes
puts "Found matching nodes:"
puts matching_nodes
